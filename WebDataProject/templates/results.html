<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="{{ url_for('static',filename='styles/main.css') }}">
	<title>Welcome to the sample!!</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<!-- TOP BAR NAVIGATION -->
<nav class="navbar navbar-inverse navbar-fixed-top">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">Team One</a>
		</div>
		<div class="collapse navbar-collapse" id="myNavbar">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
			</ul>
			<form class="navbar-form navbar-right" method="get" action="{{ url_for('results') }}">
				<div class="form-group">
					<input type="text" class="form-control" placeholder="Movie:" name="searchterm">
					<input type="hidden" class="form-control" name="pageNum" value=1>
				</div>
				<button type="submit" class="btn btn-default">Submit</button>
			</form>
		</div>
	</div>
</nav>

<body>
	<h2>
		<div id='blackText'>You</div>
		<div class='blueText'>searched</div> for: {{query}}
	</h2>
	<table class="table table-hover">
		<thead>
			<tr>
				<th scope="col">Name</th>
				<th scope="col">Genre</th>
				<th scope="col">Year of Release</th>
			</tr>
		</thead>
		<tbody>
			{% for i, n, de, g, d, rating, url, votes in results %}
			<tr data-toggle="modal" data-id={{i}} data-name='{{n}}' data-desc='{{de}}' data-genre='{{g}}' data-date='{{d}}'
			 data-rating='{{rating}}' data-url='{{url}}' data-votes='{{votes}}' data-target="#exampleModal" onclick='clickRow({{i}})'
			 id="tableRow{{i}}">
				<td>{{n}}</td>
				<td>{{g}}</td>
				<td>{{d}}</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>

	<!-- Modal -->
	<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Movie</h5>
				</div>
				<div class="modal-body">
					<table class="table">
						<tr>
							<th scope="col">Name</th>
							<th scope="col">Description</th>
							<th scope="col">Genre</th>
							<th scope="col">Date</th>
							<th scope="col">Rating</th>
							<th scope="col">Url</th>
							<th scope="col">Votes</th>
						</tr>
						<tr>
							<td id="movieName"></td>
							<td id="movieDesc"></td>
							<td id="movieGenre"></td>
							<td id="movieDate"></td>
							<td id="movieRating"></td>
							<td id="movieUrl"></td>
							<td id="movieVotes"></td>
						</tr>
					</table>
				</div>
				<form onsubmit="voteSubmit($('#movieID').attr('value'))">
					<input type="text" placeholder="0-10" name="rating" id="ratingBox" value="">
					<input type="hidden" value="" name="id" id="movieID">
					<input type="hidden" value="" name="pageNum" id="hiddenNum">
					<input type="hidden" value="" name="searchterm" id="hiddenQ">
					<button type="button" class="btn btn-primary" onclick="voteSubmit($('#movieID').attr('value'))">Save changes</button>
					<p id="error" style="color:red; visibility:hidden"> Rate from 1-10</p>
				</form>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<button type="button" class="btn btn-outline-dark" onclick="goBack()">Go Back</button>

	<a href="" id="nextButton">Next Page</a>

	<form action="{{ url_for('index') }}" method="post">
		<input type="submit" value="Return">
	</form>


	<script>
		function voteSubmit(movieID) {
			console.log($("#tableRow" + movieID).data("votes"));
			var oldVotes = $("#tableRow" + movieID).data("votes");
			var oldRating = parseFloat($("#tableRow" + movieID).data("rating"));
			var userRating = document.querySelector('#ratingBox').value;
			console.log(userRating);
			if (!$.isNumeric(userRating) || userRating < 1 || userRating > 10){
				$('#error').css('visibility', 'visible');
				return;
			}
			$('#error').css('visibility', 'hidden');
			if (oldVotes > 0) {
				var newVotes = Math.floor(1.5 * oldVotes);
				var newRating = ((oldVotes * oldRating + userRating * (oldVotes * 0.5)) / newVotes).toFixed(1);
			}
			else {
				var newVotes = 10;
				var newRating = userRating;
			}
			$('#movieRating').html(newRating);
			$('#movieVotes').html(newVotes);
			$('#tableRow' + movieID).attr('data-rating', newRating);
			$('#tableRow' + movieID).attr('data-votes', newVotes);
			console.log('name=' + $("#tableRow" + movieID).data("name")+'&desc=' + $("#tableRow" + movieID).data("desc")+'&genre=' + $("#tableRow" + movieID).data("genre") +'&date='+ $("#tableRow" + movieID).data("date") + '&rating=' + newRating +'&url='+ $("#tableRow" + movieID).data("url") + '&votes=' + newVotes);

			$.ajax({
				url: '/update/',
				data: 'name=' + $("#tableRow" + movieID).data("name")+'&desc=' + $("#tableRow" + movieID).data("desc")+'&genre=' + $("#tableRow" + movieID).data("genre") +'&date='+ $("#tableRow" + movieID).data("date") + '&rating=' + newRating +'&url='+ $("#tableRow" + movieID).data("url") + '&votes=' + newVotes ,
				type: 'POST',
				success: function (response) {
					console.log(response);
				},
				error: function (error) {
					console.log(error);
				}
			});

		}
	</script>

	<script>
		function goBack() {
			window.history.back();
		}
	</script>

	<script>
		var urlString = window.location.href;
		var url = new URL(urlString);
		var pageNum = url.searchParams.get("pageNum");
		console.log(typeof (pageNum));
		var query = url.searchParams.get("searchterm");
		$('#hiddenNum').attr('value', pageNum);
		$('#hiddenQ').attr('value', query);
		$('#nextButton').attr('href', 'http://localhost:5000/results/?searchterm=' + query + '&pageNum=' + (parseInt(pageNum) + 1));
		console.log(pageNum);
	</script>

	<script>
		$('#exampleModal').on('show.bs.modal', function (e) {
			var movie = $(e.relatedTarget).attr('data-id');
			$(this).find('.table table-hover').text();
		});
	</script>

	<script data-id="123">
		function clickRow(id) {
			$('#movieID').html($("#tableRow" + id).data("id"));
			$('#movieID').attr('value', $("#tableRow" + id).data("id"));
			$('#movieName').html($("#tableRow" + id).data("name"));
			$('#movieDesc').html($("#tableRow" + id).data("desc"));
			$('#movieGenre').html($("#tableRow" + id).data("genre"));
			$('#movieDate').html($("#tableRow" + id).data("date"));
			$('#movieRating').html($("#tableRow" + id).attr("data-rating"));
			$('#movieUrl').html('<a href="' + $("#tableRow" + id).data("url") + '">IMDB</a>');
			$('#movieVotes').html($("#tableRow" + id).attr("data-votes"));
		}
	</script>

</body>

</html>